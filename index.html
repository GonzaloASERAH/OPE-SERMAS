<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OPE SERMAS - Auxiliar Administrativo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              sermas: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                500: '#0ea5e9',
                600: '#0284c7',
                700: '#0369a1',
                900: '#0c4a6e',
              }
            }
          }
        }
      }
    </script>
    
    <!-- Babel Standalone (Compila React/TS en el navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
      .dark ::-webkit-scrollbar-thumb { background-color: #475569; }
      .perspective-1000 { perspective: 1000px; }
      .preserve-3d { transform-style: preserve-3d; }
      .backface-hidden { backface-visibility: hidden; }
      .rotate-y-180 { transform: rotateY(180deg); }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.12.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react-markdown": "https://esm.sh/react-markdown@^10.1.0",
    "jspdf": "https://esm.sh/jspdf@^4.0.0",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>
</head>
  <body class="bg-gray-50 text-gray-900 dark:bg-slate-900 dark:text-gray-100 transition-colors duration-200">
    <div id="root"></div>

    <!-- CÓDIGO DE LA APLICACIÓN UNIFICADO -->
    <script type="text/babel" data-type="module" data-presets="react, typescript">
      import React, { createContext, useContext, useState, useEffect, useMemo, useCallback, useRef } from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
      import { HashRouter, Routes, Route, Navigate, NavLink, useNavigate, useParams } from 'https://esm.sh/react-router-dom@6.22.0?deps=react@18.2.0,react-dom@18.2.0';
      import { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip } from 'https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0';
      import { 
        BookOpen, BarChart3, Layers, Moon, Sun, Menu, X, 
        Search, CheckCircle2, Clock, Circle, ArrowLeft, 
        Play, Pause, Square, CheckCircle, RotateCcw, Type, MonitorDown, 
        RefreshCw, Check, Brain 
      } from 'https://esm.sh/lucide-react@0.330.0?deps=react@18.2.0';
      import ReactMarkdown from 'https://esm.sh/react-markdown@9.0.1?deps=react@18.2.0';
      import jsPDF from 'https://esm.sh/jspdf@2.5.1';

      // --- TIPOS Y ENUMS ---
      const TopicStatus = { Pending: 'Pending', InReview: 'InReview', Mastered: 'Mastered' };
      const TopicCategory = { Legal: 'Marco Legal', SERMAS: 'Organización SERMAS', IT: 'Informática y Ofimática' };

      // --- DATOS ---
      const TOPICS = [
        {
          id: 1,
          title: "La Constitución española de 1978",
          category: TopicCategory.Legal,
          subtopics: [
            {
              id: "1.1",
              title: "Estructura y contenido",
              content: "### Bloque I: Estructura y Contenido\nLa Constitución fue aprobada en 1978..."
            },
            {
              id: "1.2",
              title: "Título preliminar",
              content: "### Bloque II: Título Preliminar\nComprende los artículos 1 al 9..."
            }
          ]
        },
        { id: 2, title: "Estatuto de Autonomía de Madrid", category: TopicCategory.Legal, subtopics: [] },
        { id: 3, title: "Ley de Gobierno de la CM", category: TopicCategory.Legal, subtopics: [] },
        { id: 4, title: "Ley 14/1986 General de Sanidad", category: TopicCategory.SERMAS, subtopics: [] },
        { id: 31, title: "Administración Electrónica CM", category: TopicCategory.SERMAS, subtopics: [] }
      ];

      const getTopicContent = (id) => {
        const t = TOPICS.find(x => x.id === id);
        if (!t) return null;
        if (t.subtopics.length === 0) {
          t.subtopics = [{ id: `${t.id}.1`, title: "Contenido", content: "Pendiente de digitalización." }];
        }
        return t;
      };

      // --- CONTEXTO ---
      const StudyContext = createContext();
      const StudyProvider = ({ children }) => {
        const [state, setState] = useState(() => {
          const s = localStorage.getItem('ope_state');
          return s ? JSON.parse(s) : { progress: {}, darkMode: false, textSize: 100 };
        });

        useEffect(() => {
          localStorage.setItem('ope_state', JSON.stringify(state));
          document.documentElement.classList.toggle('dark', state.darkMode);
        }, [state]);

        const updateStatus = (id, status) => {
          setState(prev => ({
            ...prev,
            progress: { ...prev.progress, [id]: { status, times: (prev.progress[id]?.times || 0) + 1 } }
          }));
        };

        return (
          <StudyContext.Provider value={{ ...state, setState, updateStatus }}>
            {children}
          </StudyContext.Provider>
        );
      };

      const useStudy = () => useContext(StudyContext);

      // --- VISTAS ---
      const TopicList = () => {
        const navigate = useNavigate();
        const { progress } = useStudy();
        return (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {TOPICS.map(t => (
              <div key={t.id} onClick={() => navigate(`/topic/${t.id}`)} className="bg-white dark:bg-slate-800 p-5 rounded-xl border border-gray-200 dark:border-slate-700 cursor-pointer hover:border-sermas-500 transition-all">
                <div className="flex justify-between items-start mb-2">
                  <span className="text-xs font-bold text-sermas-600">Tema {t.id}</span>
                  {progress[t.id]?.status === TopicStatus.Mastered && <CheckCircle2 className="w-4 h-4 text-green-500" />}
                </div>
                <h3 className="font-bold text-gray-900 dark:text-white">{t.title}</h3>
              </div>
            ))}
          </div>
        );
      };

      const TopicDetail = () => {
        const { id } = useParams();
        const navigate = useNavigate();
        const { updateStatus, textSize } = useStudy();
        const topic = getTopicContent(parseInt(id));
        const [active, setActive] = useState(topic?.subtopics[0]?.id);

        if (!topic) return null;

        return (
          <div className="flex flex-col lg:flex-row gap-6 h-[80vh]">
            <aside className="w-full lg:w-1/4 bg-white dark:bg-slate-800 p-4 rounded-xl border border-gray-200 dark:border-slate-700 overflow-y-auto">
              <button onClick={() => navigate('/')} className="flex items-center text-xs mb-4 text-gray-400"><ArrowLeft className="w-3 h-3 mr-1"/> Volver</button>
              <h2 className="font-bold mb-4">{topic.title}</h2>
              {topic.subtopics.map(s => (
                <button key={s.id} onClick={() => setActive(s.id)} className={`w-full text-left p-2 rounded text-sm mb-1 ${active === s.id ? 'bg-sermas-100 text-sermas-700 dark:bg-sermas-900' : ''}`}>{s.title}</button>
              ))}
            </aside>
            <main className="flex-1 bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 p-6 overflow-y-auto">
              <div className="flex justify-end mb-4">
                <button onClick={() => updateStatus(topic.id, TopicStatus.Mastered)} className="bg-green-100 text-green-700 px-3 py-1 rounded-lg text-xs font-bold flex items-center gap-1"><CheckCircle className="w-3 h-3"/> Completar</button>
              </div>
              <div style={{ fontSize: `${textSize}%` }} className="prose dark:prose-invert max-w-none">
                <ReactMarkdown>{topic.subtopics.find(x => x.id === active)?.content}</ReactMarkdown>
              </div>
            </main>
          </div>
        );
      };

      const Layout = ({ children }) => {
        const { darkMode, setState } = useStudy();
        return (
          <div className="min-h-screen flex flex-col">
            <header className="h-16 border-b bg-white/80 dark:bg-slate-900/80 backdrop-blur flex items-center justify-between px-6 sticky top-0 z-50">
              <div className="flex items-center gap-2 font-bold text-sermas-600"><BookOpen/> OPE SERMAS</div>
              <button onClick={() => setState(p => ({ ...p, darkMode: !p.darkMode }))} className="p-2 bg-gray-100 dark:bg-slate-800 rounded-full">{darkMode ? <Sun className="text-amber-400"/> : <Moon/>}</button>
            </header>
            <div className="flex-1 p-6 max-w-7xl mx-auto w-full">{children}</div>
          </div>
        );
      };

      const App = () => (
        <StudyProvider>
          <HashRouter>
            <Layout>
              <Routes>
                <Route path="/" element={<TopicList />} />
                <Route path="/topic/:id" element={<TopicDetail />} />
                <Route path="*" element={<Navigate to="/" />} />
              </Routes>
            </Layout>
          </HashRouter>
        </StudyProvider>
      );

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>