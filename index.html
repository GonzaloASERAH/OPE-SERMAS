<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OPE SERMAS - Auxiliar Administrativo</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              sermas: {
                50: '#f0f9ff',
                100: '#e0f2fe',
                500: '#0ea5e9',
                600: '#0284c7',
                700: '#0369a1',
                900: '#0c4a6e',
              }
            }
          }
        }
      }
    </script>
    
    <!-- Babel Standalone for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      /* Custom scrollbar for better aesthetics */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 20px;
      }
      .dark ::-webkit-scrollbar-thumb {
        background-color: #475569;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react-router-dom": "https://esm.sh/react-router-dom@^7.12.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0",
    "react-markdown": "https://esm.sh/react-markdown@^10.1.0",
    "jspdf": "https://esm.sh/jspdf@^4.0.0",
    "recharts": "https://esm.sh/recharts@^3.6.0"
  }
}
</script>
</head>
  <body class="bg-gray-50 text-gray-900 dark:bg-slate-900 dark:text-gray-100 transition-colors duration-200">
    <div id="root"></div>

    <!-- Application Code -->
    <script type="text/babel" data-type="module" data-presets="react, typescript">
      // 1. IMPORTS
      import React, { createContext, useContext, useState, useEffect, useMemo, useCallback, useRef } from 'https://esm.sh/react@18.2.0';
      import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
      import { HashRouter, Routes, Route, Navigate, NavLink, useNavigate, useParams, useLocation } from 'https://esm.sh/react-router-dom@6.22.0?deps=react@18.2.0,react-dom@18.2.0';
      import { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip } from 'https://esm.sh/recharts@2.12.0?deps=react@18.2.0,react-dom@18.2.0';
      import { 
        BookOpen, BarChart3, Layers, Settings, Moon, Sun, Menu, X, 
        Search, CheckCircle2, Clock, Circle, Filter, 
        ArrowLeft, Play, Pause, Square, CheckCircle, RotateCcw, Type, MonitorDown, 
        RefreshCw, Check, Brain 
      } from 'https://esm.sh/lucide-react@0.330.0?deps=react@18.2.0';
      import ReactMarkdown from 'https://esm.sh/react-markdown@9.0.1?deps=react@18.2.0';
      import jsPDF from 'https://esm.sh/jspdf@2.5.1';

      // 2. TYPES
      enum TopicStatus {
        Pending = 'Pending',
        InReview = 'InReview',
        Mastered = 'Mastered',
      }

      enum TopicCategory {
        Legal = 'Marco Legal',
        SERMAS = 'Organización SERMAS',
        IT = 'Informática y Ofimática',
        Other = 'Otros',
      }

      interface Subtopic {
        id: string;
        title: string;
        content: string;
      }

      interface Topic {
        id: number;
        title: string;
        category: TopicCategory;
        subtopics: Subtopic[];
      }

      interface UserProgress {
        topicId: number;
        status: TopicStatus;
        lastStudied?: string;
        timesReviewed: number;
      }

      interface AppState {
        progress: Record<number, UserProgress>;
        darkMode: boolean;
        textSize: number;
      }

      // 3. DATA
      const TOPICS: Topic[] = [
        {
          id: 1,
          title: "La Constitución española de 1978",
          category: TopicCategory.Legal,
          subtopics: [
            {
              id: "1.1",
              title: "Estructura y contenido",
              content: `
### Bloque I: Estructura y Contenido
La Constitución fue aprobada por las Cortes y ratificada por el pueblo español en 1978, entrando en vigor el mismo día de su publicación en el BOE, el 29 de diciembre.

**Composición cuantitativa:**
Consta de un Preámbulo, 169 artículos, cuatro disposiciones adicionales, nueve transitorias, una derogatoria y una final.

**División cualitativa:**
El texto se organiza en un Título Preliminar y diez Títulos numerados.

**Partes de la Constitución:**
* **Parte Dogmática:** Incluye el Título Preliminar y el Título 1 (derechos y principios fundamentales).
* **Parte Orgánica:** Regula los grandes órganos del Estado: la Corona (Título 2), las Cortes Generales (Título 3), el Gobierno y la Administración (Título 4), el Poder Judicial (Título 6) y la Organización Territorial (Título 8).
* **Garantía y Reforma:** Recogidas en el Título 9 (Tribunal Constitucional) y el Título 10 (Reforma Constitucional).
              `
            },
            {
              id: "1.2",
              title: "Título preliminar",
              content: `
### Bloque II: Título Preliminar
Comprende los artículos 1 al 9 y establece los pilares del Estado.

* **Definición de Estado (Artículo 1):** España se constituye en un Estado social y democrático de Derecho. Sus valores superiores son la libertad, la justicia, la igualdad y el pluralismo político.
* **Soberanía y Forma Política (Artículo 1):** La soberanía nacional reside en el pueblo español y la forma política es la Monarquía parlamentaria.
* **Unidad y Autonomía (Artículo 2):** Se fundamenta en la unidad indisoluble de la Nación, pero reconoce el derecho a la autonomía de sus nacionalidades y regiones.
* **Idioma y Símbolos (Artículo 3 al 5):** El castellano es la lengua oficial del Estado; la bandera tiene tres franjas (roja, amarilla y roja, siendo la amarilla de doble anchura) y la capital es la villa de Madrid.
* **Instituciones (Artículo 6 al 8):** Los partidos políticos, sindicatos y asociaciones empresariales son fundamentales para la participación. Las Fuerzas Armadas tienen la misión de garantizar la soberanía, independencia e integridad territorial.
* **Principios Jurídicos (Artículo 9):** Garantiza la legalidad, la jerarquía normativa, la publicidad de las normas y la seguridad jurídica.
              `
            },
            {
              id: "1.3",
              title: "Derechos y deberes fundamentales",
              content: `
### Bloque III: Derechos y Deberes Fundamentales
Se encuentran en el Título I (Artículos 10 al 55), el cual se divide en cinco capítulos:

* **Artículo 10:** Establece que la dignidad de la persona y sus derechos inviolables son el fundamento del orden político.
* **Capítulo I (Españoles y extranjeros):** Regula la mayoría de edad a los 18 años (Artículo 12) y el derecho de asilo.
* **Capítulo II (Derechos y libertades):**
    * **Artículo 14:** Proclama la igualdad ante la ley sin discriminación.
    * **Sección 1.ª (Artículos 15 al 29):** Derechos fundamentales y libertades públicas (vida, libertad ideológica, libertad y seguridad, honor, educación, libertad sindical y huelga).
    * **Sección 2.ª (Artículos 30 al 38):** Derechos y deberes de los ciudadanos (defensa de España, sostenimiento de gastos públicos, matrimonio, propiedad privada y derecho al trabajo).
* **Capítulo III (Principios rectores):** Normas que deben guiar la actuación de los poderes públicos, como la protección de la familia, la Seguridad Social y la cultura.
* **Garantías y Suspensión (Capítulos 4 y 5):** Los derechos de la Sección 1.ª y el Artículo 14 cuentan con la protección del recurso de amparo ante el Tribunal Constitucional. Algunos derechos pueden suspenderse en estados de excepción o sitio.
              `
            },
            {
              id: "1.4",
              title: "La protección de la salud en la Constitución",
              content: `
### Bloque IV: La Protección de la Salud
La salud se regula principalmente en el **Artículo 43**, dentro de los principios rectores de la política social y económica.

* **Derecho a la protección:** La Constitución reconoce el derecho a la protección de la salud.
* **Obligación de los Poderes Públicos:** Compete a estos organizar y tutelar la salud pública mediante medidas preventivas y las prestaciones y servicios necesarios.
* **Fomento de la salud:** Los poderes públicos deben fomentar la educación sanitaria, la educación física, el deporte y la adecuada utilización del ocio.
* **Seguridad Social (Artículo 41):** Los poderes públicos deben mantener un régimen público de Seguridad Social que garantice la asistencia y prestaciones sociales suficientes ante situaciones de necesidad.
* **Consumidores (Artículo 51):** Se establece que los poderes públicos garantizarán la defensa de los consumidores, protegiendo especialmente su seguridad y salud.
* **Aplicación jurídica (Artículo 53.3):** El reconocimiento de la protección de la salud informará la legislación positiva y la práctica judicial, pero solo podrá ser alegado ante la jurisdicción ordinaria de acuerdo con las leyes que lo desarrollen.

**Estrategia de estudio:**
Considere que la Constitución es la "partitura maestra" sobre la que se interpreta toda la normativa sanitaria española. El Título Preliminar marca el ritmo (Estado de Derecho), el Título I define las notas (derechos ciudadanos) y el Artículo 43 es el instrumento específico que permite al SERMAS existir y funcionar.
              `
            }
          ]
        },
        { id: 2, title: "El Estatuto de Autonomía de la Comunidad de Madrid", category: TopicCategory.Legal, subtopics: [] },
        { id: 3, title: "La Ley de Gobierno y Administración de la Comunidad de Madrid", category: TopicCategory.Legal, subtopics: [] },
        { id: 4, title: "Ley 14/1986 General de Sanidad", category: TopicCategory.SERMAS, subtopics: [] },
        { id: 5, title: "Ley 12/2001 de Ordenación Sanitaria de la CM", category: TopicCategory.SERMAS, subtopics: [] },
        { id: 6, title: "Ley Orgánica contra la Violencia de Género e Igualdad", category: TopicCategory.Legal, subtopics: [] },
        { id: 7, title: "Ley 16/2003 de cohesión y calidad del SNS", category: TopicCategory.Legal, subtopics: [] },
        { id: 8, title: "Las modalidades de la asistencia sanitaria", category: TopicCategory.SERMAS, subtopics: [] },
        { id: 9, title: "Ley 40/2015 de Régimen Jurídico del Sector Público", category: TopicCategory.Legal, subtopics: [] },
        { id: 10, title: "Ley 39/2015 del Procedimiento Administrativo Común (I)", category: TopicCategory.Legal, subtopics: [] },
        { id: 11, title: "Ley 39/2015 del Procedimiento Administrativo Común (II)", category: TopicCategory.Legal, subtopics: [] },
        { id: 12, title: "Ley 11/2017 de Buen gobierno del SERMAS", category: TopicCategory.SERMAS, subtopics: [] },
        { id: 13, title: "Ley 31/1995 de Prevención de Riesgos laborales", category: TopicCategory.Legal, subtopics: [] },
        { id: 14, title: "Estatuto Básico del Empleado Público", category: TopicCategory.Legal, subtopics: [] },
        { id: 15, title: "Estatuto Marco del personal estatutario (I)", category: TopicCategory.Legal, subtopics: [] },
        { id: 16, title: "Estatuto Marco del personal estatutario (II)", category: TopicCategory.Legal, subtopics: [] },
        { id: 17, title: "Estatuto Marco del personal estatutario (III)", category: TopicCategory.Legal, subtopics: [] },
        { id: 18, title: "Protección integral a la infancia y adolescencia", category: TopicCategory.Legal, subtopics: [] },
        { id: 19, title: "Ley General de la Seguridad Social", category: TopicCategory.Legal, subtopics: [] },
        { id: 20, title: "Documentación de uso de las Instituciones Sanitarias", category: TopicCategory.SERMAS, subtopics: [] },
        { id: 21, title: "El servicio de Admisión y documentación clínica", category: TopicCategory.SERMAS, subtopics: [] },
        { id: 22, title: "Información administrativa y atención al ciudadano", category: TopicCategory.SERMAS, subtopics: [] },
        { id: 23, title: "La protección de datos (RGPD)", category: TopicCategory.Legal, subtopics: [] },
        { id: 24, title: "Ley de Contratos del Sector Público", category: TopicCategory.Legal, subtopics: [] },
        { id: 25, title: "Los centros hospitalarios", category: TopicCategory.SERMAS, subtopics: [] },
        { id: 26, title: "Plataformas informáticas sanitarias (Cibeles, HCE)", category: TopicCategory.SERMAS, subtopics: [] },
        { id: 27, title: "Trabajo en el entorno gráfico de Windows 10", category: TopicCategory.IT, subtopics: [] },
        { id: 28, title: "Word 2016 principales funciones", category: TopicCategory.IT, subtopics: [] },
        { id: 29, title: "Excel 2016 principales funciones", category: TopicCategory.IT, subtopics: [] },
        { id: 30, title: "Redes de Comunicaciones e Internet", category: TopicCategory.IT, subtopics: [] },
        { id: 31, title: "La Administración Electrónica en la CM", category: TopicCategory.SERMAS, subtopics: [] },
      ];

      const getTopicContent = (topicId: number): Topic => {
        const topic = TOPICS.find(t => t.id === topicId);
        if (!topic) throw new Error("Topic not found");

        if (topic.subtopics.length === 0) {
          return {
            ...topic,
            subtopics: [
              { id: `${topic.id}.1`, title: "Introducción y Conceptos Básicos", content: "Contenido pendiente de digitalización. Consulte el temario oficial en PDF." },
              { id: `${topic.id}.2`, title: "Marco Normativo", content: "Referencias legales y normativa aplicable a este tema." },
              { id: `${topic.id}.3`, title: "Aplicación Práctica", content: "Ejemplos de aplicación en el entorno del SERMAS." }
            ]
          }
        }
        return topic;
      };

      // 4. CONTEXT
      interface StudyContextType extends AppState {
        toggleDarkMode: () => void;
        updateTopicStatus: (topicId: number, status: TopicStatus) => void;
        setTextSize: (size: number) => void;
        getTopicProgress: (topicId: number) => UserProgress;
      }

      const defaultState: AppState = {
        progress: {},
        darkMode: false,
        textSize: 100,
      };

      const StudyContext = createContext<StudyContextType | undefined>(undefined);

      const StudyProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
        const [state, setState] = useState<AppState>(() => {
          const saved = localStorage.getItem('sermas_app_state');
          return saved ? JSON.parse(saved) : defaultState;
        });

        useEffect(() => {
          localStorage.setItem('sermas_app_state', JSON.stringify(state));
          if (state.darkMode) {
            document.documentElement.classList.add('dark');
          } else {
            document.documentElement.classList.remove('dark');
          }
        }, [state]);

        const toggleDarkMode = () => {
          setState(prev => ({ ...prev, darkMode: !prev.darkMode }));
        };

        const setTextSize = (size: number) => {
          setState(prev => ({ ...prev, textSize: size }));
        };

        const updateTopicStatus = (topicId: number, status: TopicStatus) => {
          setState(prev => {
            const currentProgress = prev.progress[topicId] || { topicId, timesReviewed: 0 };
            return {
              ...prev,
              progress: {
                ...prev.progress,
                [topicId]: {
                  ...currentProgress,
                  status,
                  lastStudied: new Date().toISOString(),
                  timesReviewed: currentProgress.timesReviewed + 1
                }
              }
            };
          });
        };

        const getTopicProgress = (topicId: number): UserProgress => {
          return state.progress[topicId] || { topicId, status: TopicStatus.Pending, timesReviewed: 0 };
        };

        return (
          <StudyContext.Provider value={{
            ...state,
            toggleDarkMode,
            updateTopicStatus,
            setTextSize,
            getTopicProgress
          }}>
            {children}
          </StudyContext.Provider>
        );
      };

      const useStudy = () => {
        const context = useContext(StudyContext);
        if (!context) throw new Error("useStudy must be used within StudyProvider");
        return context;
      };

      // 5. COMPONENTS
      const Layout: React.FC<{ children: React.ReactNode }> = ({ children }) => {
        const { darkMode, toggleDarkMode } = useStudy();
        const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

        const navItems = [
          { to: '/', label: 'Temario', icon: BookOpen },
          { to: '/flashcards', label: 'Repaso', icon: Layers },
          { to: '/stats', label: 'Progreso', icon: BarChart3 },
        ];

        return (
          <div className="min-h-screen flex flex-col transition-colors duration-200">
            {/* Header */}
            <header className="sticky top-0 z-50 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-gray-200 dark:border-slate-800 shadow-sm">
              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div className="flex justify-between h-16 items-center">
                  <div className="flex items-center gap-2">
                    <div className="bg-sermas-600 p-1.5 rounded-lg">
                      <BookOpen className="h-6 w-6 text-white" />
                    </div>
                    <span className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-sermas-700 to-sermas-500 dark:from-sermas-400 dark:to-sermas-200">
                      OPE SERMAS
                    </span>
                  </div>

                  {/* Desktop Nav */}
                  <nav className="hidden md:flex space-x-8">
                    {navItems.map((item) => (
                      <NavLink
                        key={item.to}
                        to={item.to}
                        className={({ isActive }) =>
                          `flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-colors ${
                            isActive
                              ? 'text-sermas-600 bg-sermas-50 dark:text-sermas-400 dark:bg-slate-800'
                              : 'text-gray-600 dark:text-gray-300 hover:text-sermas-600 dark:hover:text-white'
                          }`
                        }
                      >
                        <item.icon className="w-4 h-4" />
                        {item.label}
                      </NavLink>
                    ))}
                  </nav>

                  <div className="flex items-center gap-2">
                    <button
                      onClick={toggleDarkMode}
                      className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-800 transition-colors"
                      aria-label="Toggle Dark Mode"
                    >
                      {darkMode ? <Sun className="w-5 h-5 text-amber-400" /> : <Moon className="w-5 h-5 text-slate-600" />}
                    </button>
                    
                    <button 
                      className="md:hidden p-2 text-gray-600 dark:text-gray-300"
                      onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                    >
                      {mobileMenuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
                    </button>
                  </div>
                </div>
              </div>

              {/* Mobile Menu */}
              {mobileMenuOpen && (
                <div className="md:hidden border-t border-gray-200 dark:border-slate-800 bg-white dark:bg-slate-900">
                  <div className="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    {navItems.map((item) => (
                      <NavLink
                        key={item.to}
                        to={item.to}
                        onClick={() => setMobileMenuOpen(false)}
                        className={({ isActive }) =>
                          `block px-3 py-2 rounded-md text-base font-medium ${
                            isActive
                              ? 'text-sermas-600 bg-sermas-50 dark:text-sermas-400 dark:bg-slate-800'
                              : 'text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-800'
                          }`
                        }
                      >
                        <div className="flex items-center gap-3">
                          <item.icon className="w-5 h-5" />
                          {item.label}
                        </div>
                      </NavLink>
                    ))}
                  </div>
                </div>
              )}
            </header>

            {/* Main Content */}
            <main className="flex-1 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">
              {children}
            </main>
          </div>
        );
      };

      // 6. PAGES
      // TopicList.tsx
      const TopicList: React.FC = () => {
        const navigate = useNavigate();
        const { getTopicProgress } = useStudy();
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedCategory, setSelectedCategory] = useState<TopicCategory | 'All'>('All');

        const filteredTopics = useMemo(() => {
          return TOPICS.filter(topic => {
            const matchesSearch = topic.title.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                  topic.id.toString().includes(searchTerm);
            const matchesCategory = selectedCategory === 'All' || topic.category === selectedCategory;
            return matchesSearch && matchesCategory;
          });
        }, [searchTerm, selectedCategory]);

        const categories = Object.values(TopicCategory);

        const getStatusIcon = (status: TopicStatus) => {
          switch (status) {
            case TopicStatus.Mastered:
              return <CheckCircle2 className="w-5 h-5 text-green-500" />;
            case TopicStatus.InReview:
              return <Clock className="w-5 h-5 text-amber-500" />;
            default:
              return <Circle className="w-5 h-5 text-gray-300 dark:text-gray-600" />;
          }
        };

        return (
          <div className="space-y-6">
            <div className="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
              <div>
                <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Temario Oficial</h1>
                <p className="text-gray-500 dark:text-gray-400">31 Temas de Auxiliar Administrativo</p>
              </div>
              
              <div className="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" />
                  <input
                    type="text"
                    placeholder="Buscar tema..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-9 pr-4 py-2 w-full sm:w-64 border border-gray-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-sermas-500 focus:border-transparent outline-none"
                  />
                </div>
                
                <select
                  value={selectedCategory}
                  onChange={(e) => setSelectedCategory(e.target.value as TopicCategory | 'All')}
                  className="px-3 py-2 border border-gray-300 dark:border-slate-700 rounded-lg bg-white dark:bg-slate-800 text-sm focus:ring-2 focus:ring-sermas-500 outline-none"
                >
                  <option value="All">Todas las categorías</option>
                  {categories.map(cat => (
                    <option key={cat} value={cat}>{cat}</option>
                  ))}
                </select>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {filteredTopics.map((topic) => {
                const progress = getTopicProgress(topic.id);
                return (
                  <div
                    key={topic.id}
                    onClick={() => navigate(`/topic/${topic.id}`)}
                    className="group cursor-pointer bg-white dark:bg-slate-800 rounded-xl p-5 border border-gray-200 dark:border-slate-700 shadow-sm hover:shadow-md hover:border-sermas-300 dark:hover:border-sermas-700 transition-all"
                  >
                    <div className="flex justify-between items-start mb-3">
                      <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-slate-700 dark:text-gray-300">
                        Tema {topic.id}
                      </span>
                      {getStatusIcon(progress.status)}
                    </div>
                    
                    <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-2 group-hover:text-sermas-600 dark:group-hover:text-sermas-400 transition-colors">
                      {topic.title}
                    </h3>
                    
                    <div className="mt-4 pt-4 border-t border-gray-100 dark:border-slate-700 flex justify-between items-center text-xs text-gray-500 dark:text-gray-400">
                      <span>{topic.category}</span>
                      {progress.timesReviewed > 0 && (
                        <span>Repasado: {progress.timesReviewed} veces</span>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            {filteredTopics.length === 0 && (
              <div className="text-center py-12">
                <p className="text-gray-500 dark:text-gray-400">No se encontraron temas con esos criterios.</p>
              </div>
            )}
          </div>
        );
      };

      // TopicDetail.tsx
      const TopicDetail: React.FC = () => {
        const { id } = useParams<{ id: string }>();
        const navigate = useNavigate();
        const { textSize, setTextSize, updateTopicStatus, getTopicProgress } = useStudy();
        
        const [topic, setTopic] = useState<Topic | null>(null);
        const [activeSubtopic, setActiveSubtopic] = useState<string | null>(null);
        
        const [isSpeaking, setIsSpeaking] = useState(false);
        const [isPaused, setIsPaused] = useState(false);
        const [rate, setRate] = useState(1);
        const utteranceRef = useRef<SpeechSynthesisUtterance | null>(null);

        useEffect(() => {
          if (id) {
            try {
              const data = getTopicContent(parseInt(id));
              setTopic(data);
              if (data.subtopics.length > 0) {
                setActiveSubtopic(data.subtopics[0].id);
              }
            } catch (e) {
              navigate('/');
            }
          }
        }, [id, navigate]);

        const stopSpeech = useCallback(() => {
          window.speechSynthesis.cancel();
          setIsSpeaking(false);
          setIsPaused(false);
        }, []);

        useEffect(() => {
          return () => {
            stopSpeech();
          };
        }, [stopSpeech]);

        const toggleSpeech = () => {
          if (!topic || !activeSubtopic) return;

          if (isSpeaking && !isPaused) {
            window.speechSynthesis.pause();
            setIsPaused(true);
            return;
          }

          if (isSpeaking && isPaused) {
            window.speechSynthesis.resume();
            setIsPaused(false);
            return;
          }

          const subtopic = topic.subtopics.find(s => s.id === activeSubtopic);
          if (subtopic) {
            const textToRead = subtopic.content.replace(/[#*]/g, '');
            
            const utterance = new SpeechSynthesisUtterance(textToRead);
            utterance.lang = 'es-ES';
            utterance.rate = rate;
            utterance.onend = () => {
              setIsSpeaking(false);
              setIsPaused(false);
            };
            
            utteranceRef.current = utterance;
            window.speechSynthesis.speak(utterance);
            setIsSpeaking(true);
          }
        };

        const handleExportPDF = () => {
          if (!topic) return;
          const doc = new jsPDF();
          doc.setFontSize(16);
          doc.text(topic.title, 10, 10);
          doc.setFontSize(12);
          let y = 20;
          
          topic.subtopics.forEach(sub => {
             if (y > 270) { doc.addPage(); y = 20; }
             doc.setFont("helvetica", "bold");
             doc.text(sub.title, 10, y);
             y += 7;
             doc.setFont("helvetica", "normal");
             const lines = doc.splitTextToSize(sub.content.replace(/[#*]/g, ''), 180);
             doc.text(lines, 10, y);
             y += (lines.length * 5) + 10;
          });

          doc.save(`Tema_${topic.id}_OPE_SERMAS.pdf`);
        };

        if (!topic) return <div className="p-8 text-center">Cargando...</div>;

        const currentProgress = getTopicProgress(topic.id);
        const currentSubtopic = topic.subtopics.find(s => s.id === activeSubtopic);

        return (
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[calc(100vh-8rem)]">
            <aside className="lg:col-span-1 bg-white dark:bg-slate-800 rounded-xl p-4 border border-gray-200 dark:border-slate-700 overflow-y-auto custom-scrollbar">
              <button 
                onClick={() => navigate('/')} 
                className="flex items-center text-sm text-gray-500 hover:text-sermas-600 mb-6"
              >
                <ArrowLeft className="w-4 h-4 mr-1" /> Volver al temario
              </button>

              <h2 className="font-bold text-gray-900 dark:text-white mb-4">{topic.title}</h2>
              
              <div className="space-y-2">
                {topic.subtopics.map(sub => (
                  <button
                    key={sub.id}
                    onClick={() => {
                      stopSpeech();
                      setActiveSubtopic(sub.id);
                    }}
                    className={`w-full text-left p-3 rounded-lg text-sm transition-colors ${
                      activeSubtopic === sub.id
                        ? 'bg-sermas-50 text-sermas-700 border border-sermas-200 dark:bg-sermas-900/30 dark:text-sermas-300 dark:border-sermas-800'
                        : 'hover:bg-gray-50 dark:hover:bg-slate-700 text-gray-600 dark:text-gray-400'
                    }`}
                  >
                    <div className="font-medium text-xs opacity-70 mb-0.5">{sub.id}</div>
                    {sub.title}
                  </button>
                ))}
              </div>
            </aside>

            <section className="lg:col-span-3 flex flex-col bg-white dark:bg-slate-800 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm overflow-hidden">
              <div className="p-4 border-b border-gray-100 dark:border-slate-700 flex flex-wrap gap-4 items-center justify-between bg-gray-50 dark:bg-slate-800/50">
                <div className="flex items-center gap-2">
                  <button
                    onClick={toggleSpeech}
                    className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                      isSpeaking && !isPaused
                        ? 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-300'
                        : 'bg-sermas-100 text-sermas-700 dark:bg-sermas-900/30 dark:text-sermas-300'
                    }`}
                  >
                    {isSpeaking && !isPaused ? <Pause className="w-4 h-4" /> : <Play className="w-4 h-4" />}
                    {isSpeaking && !isPaused ? 'Pausar' : 'Escuchar'}
                  </button>
                  
                  {isSpeaking && (
                     <button onClick={stopSpeech} className="p-1.5 rounded-lg hover:bg-gray-200 dark:hover:bg-slate-700">
                       <Square className="w-4 h-4 text-gray-600 dark:text-gray-400 fill-current" />
                     </button>
                  )}

                  <select 
                    value={rate} 
                    onChange={(e) => setRate(parseFloat(e.target.value))}
                    className="bg-transparent border-none text-xs text-gray-600 dark:text-gray-400 focus:ring-0 cursor-pointer"
                  >
                    <option value="0.75">0.75x</option>
                    <option value="1">1.0x</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                  </select>
                </div>

                <div className="flex items-center gap-3">
                   <div className="flex items-center gap-1 border-r border-gray-300 dark:border-slate-600 pr-3 mr-1">
                     <Type className="w-3 h-3 text-gray-400" />
                     <input 
                       type="range" 
                       min="80" 
                       max="150" 
                       value={textSize} 
                       onChange={(e) => setTextSize(parseInt(e.target.value))}
                       className="w-20 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                     />
                   </div>

                   <button 
                     onClick={handleExportPDF}
                     title="Exportar PDF"
                     className="p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-500"
                   >
                     <MonitorDown className="w-5 h-5" />
                   </button>

                   <button
                    onClick={() => {
                      const newStatus = currentProgress.status === TopicStatus.Mastered ? TopicStatus.Pending : TopicStatus.Mastered;
                      updateTopicStatus(topic.id, newStatus);
                    }}
                    className={`flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${
                      currentProgress.status === TopicStatus.Mastered
                        ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-300'
                        : 'bg-gray-100 text-gray-600 dark:bg-slate-700 dark:text-gray-300 hover:bg-gray-200'
                    }`}
                  >
                    {currentProgress.status === TopicStatus.Mastered ? (
                      <><CheckCircle className="w-4 h-4" /> Estudiado</>
                    ) : (
                      <><RotateCcw className="w-4 h-4" /> Marcar leído</>
                    )}
                  </button>
                </div>
              </div>

              <div className="flex-1 overflow-y-auto p-8 custom-scrollbar relative">
                {currentSubtopic ? (
                  <div 
                    className="prose dark:prose-invert prose-slate max-w-none transition-all duration-200"
                    style={{ fontSize: `${textSize}%` }}
                  >
                    <h2 className="text-2xl font-bold mb-6 text-sermas-800 dark:text-sermas-200">
                      {currentSubtopic.id} {currentSubtopic.title}
                    </h2>
                    <ReactMarkdown 
                      components={{
                        h3: ({node, ...props}) => <h3 className="text-xl font-semibold mt-6 mb-3 text-gray-800 dark:text-gray-100" {...props} />,
                        p: ({node, ...props}) => <p className="mb-4 leading-relaxed text-gray-600 dark:text-gray-300" {...props} />,
                        ul: ({node, ...props}) => <ul className="list-disc pl-5 space-y-2 mb-4" {...props} />,
                        li: ({node, ...props}) => <li className="text-gray-600 dark:text-gray-300" {...props} />,
                        strong: ({node, ...props}) => <strong className="font-bold text-sermas-700 dark:text-sermas-300" {...props} />
                      }}
                    >
                      {currentSubtopic.content}
                    </ReactMarkdown>
                  </div>
                ) : (
                  <div className="flex items-center justify-center h-full text-gray-400">
                    Selecciona un subtema para comenzar
                  </div>
                )}
              </div>
            </section>
          </div>
        );
      };

      // Dashboard.tsx
      const Dashboard: React.FC = () => {
        const { progress } = useStudy();

        const totalTopics = TOPICS.length;
        const mastered = Object.values(progress).filter((p) => p.status === TopicStatus.Mastered).length;
        const inReview = Object.values(progress).filter((p) => p.status === TopicStatus.InReview).length;
        const pending = totalTopics - mastered - inReview;

        const pieData = [
          { name: 'Estudiado', value: mastered, color: '#22c55e' },
          { name: 'En Repaso', value: inReview, color: '#f59e0b' },
          { name: 'Pendiente', value: pending, color: '#e2e8f0' },
        ];

        const categoryStats = TOPICS.reduce((acc, topic) => {
          if (!acc[topic.category]) acc[topic.category] = { total: 0, completed: 0 };
          acc[topic.category].total += 1;
          if (progress[topic.id]?.status === TopicStatus.Mastered) {
            acc[topic.category].completed += 1;
          }
          return acc;
        }, {});

        const barData = Object.entries(categoryStats).map(([name, stats]) => ({
          name: name.split(' ')[0], 
          completed: stats.completed,
          total: stats.total
        }));

        return (
          <div className="space-y-8">
            <div>
              <h1 className="text-2xl font-bold text-gray-900 dark:text-white">Panel de Progreso</h1>
              <p className="text-gray-500 dark:text-gray-400">Estadísticas de tu preparación OPE</p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="bg-white dark:bg-slate-800 p-6 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm flex flex-col items-center">
                 <h3 className="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Progreso Global</h3>
                 <div className="w-full h-48">
                   <ResponsiveContainer width="100%" height="100%">
                     <PieChart>
                       <Pie
                         data={pieData}
                         innerRadius={60}
                         outerRadius={80}
                         paddingAngle={5}
                         dataKey="value"
                       >
                         {pieData.map((entry, index) => (
                           <Cell key={`cell-${index}`} fill={entry.color} stroke="none" />
                         ))}
                       </Pie>
                     </PieChart>
                   </ResponsiveContainer>
                 </div>
                 <div className="text-center mt-2">
                   <span className="text-3xl font-bold text-sermas-600">{Math.round((mastered / totalTopics) * 100)}%</span>
                   <p className="text-sm text-gray-500">Completado</p>
                 </div>
              </div>

              <div className="md:col-span-2 bg-white dark:bg-slate-800 p-6 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm">
                <h3 className="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Por Categoría</h3>
                <div className="w-full h-64">
                   <ResponsiveContainer width="100%" height="100%">
                     <BarChart data={barData} layout="vertical" margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                       <XAxis type="number" hide />
                       <YAxis dataKey="name" type="category" width={100} tick={{fill: '#94a3b8', fontSize: 12}} />
                       <Tooltip 
                          contentStyle={{ backgroundColor: '#1e293b', border: 'none', color: '#fff', borderRadius: '8px' }}
                          itemStyle={{ color: '#fff' }}
                       />
                       <Bar dataKey="total" fill="#f1f5f9" radius={[0, 4, 4, 0]} barSize={20} stackId="a" />
                       <Bar dataKey="completed" fill="#0ea5e9" radius={[0, 4, 4, 0]} barSize={20} stackId="a" />
                     </BarChart>
                   </ResponsiveContainer>
                </div>
              </div>
            </div>

            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              {[
                { label: 'Temas Totales', val: totalTopics, color: 'text-gray-600 dark:text-gray-300' },
                { label: 'Estudiados', val: mastered, color: 'text-green-600' },
                { label: 'En Revisión', val: inReview, color: 'text-amber-500' },
                { label: 'Pendientes', val: pending, color: 'text-gray-400' },
              ].map((stat) => (
                <div key={stat.label} className="bg-white dark:bg-slate-800 p-4 rounded-xl border border-gray-200 dark:border-slate-700 shadow-sm text-center">
                  <p className={`text-2xl font-bold mb-1 ${stat.color}`}>{stat.val}</p>
                  <p className="text-xs text-gray-500 uppercase tracking-wider">{stat.label}</p>
                </div>
              ))}
            </div>
          </div>
        );
      };

      // FlashcardsMode.tsx
      interface Flashcard {
        id: string;
        question: string;
        answer: string;
        topicId: number;
      }

      const FlashcardsMode: React.FC = () => {
        const [cards, setCards] = useState<Flashcard[]>([]);
        const [currentIndex, setCurrentIndex] = useState(0);
        const [isFlipped, setIsFlipped] = useState(false);
        const [sessionOver, setSessionOver] = useState(false);
        const { updateTopicStatus } = useStudy();

        useEffect(() => {
          const generatedCards: Flashcard[] = [];
          
          const topic1 = getTopicContent(1);
          topic1.subtopics.forEach(sub => {
            generatedCards.push({
              id: sub.id,
              question: `¿Qué abarca el apartado: ${sub.title}?`,
              answer: sub.content.substring(0, 150) + "...",
              topicId: 1
            });
          });

          TOPICS.slice(1, 6).forEach(t => {
             generatedCards.push({
               id: `t${t.id}`,
               question: `Resume el objetivo principal de: ${t.title}`,
               answer: "Contenido pendiente de estudio. Revisa el tema completo.",
               topicId: t.id
             });
          });

          setCards(generatedCards.sort(() => Math.random() - 0.5));
        }, []);

        const handleNext = (remembered: boolean) => {
          if (remembered) {
            updateTopicStatus(cards[currentIndex].topicId, TopicStatus.InReview);
          }

          setIsFlipped(false);
          setTimeout(() => {
            if (currentIndex < cards.length - 1) {
              setCurrentIndex(prev => prev + 1);
            } else {
              setSessionOver(true);
            }
          }, 200);
        };

        const restart = () => {
          setCards(prev => [...prev].sort(() => Math.random() - 0.5));
          setCurrentIndex(0);
          setSessionOver(false);
          setIsFlipped(false);
        };

        if (cards.length === 0) return <div className="p-8 text-center">Generando tarjetas...</div>;

        if (sessionOver) {
          return (
            <div className="flex flex-col items-center justify-center h-[60vh] text-center">
              <div className="bg-green-100 dark:bg-green-900/30 p-4 rounded-full mb-6">
                <Brain className="w-12 h-12 text-green-600 dark:text-green-400" />
              </div>
              <h2 className="text-2xl font-bold text-gray-900 dark:text-white mb-2">¡Repaso completado!</h2>
              <p className="text-gray-600 dark:text-gray-400 mb-8">Has revisado {cards.length} tarjetas.</p>
              <button 
                onClick={restart}
                className="flex items-center gap-2 px-6 py-3 bg-sermas-600 text-white rounded-xl hover:bg-sermas-700 transition-colors shadow-lg"
              >
                <RefreshCw className="w-5 h-5" /> Repasar otra vez
              </button>
            </div>
          );
        }

        const currentCard = cards[currentIndex];

        return (
          <div className="flex flex-col items-center justify-center min-h-[70vh] max-w-2xl mx-auto">
            <div className="w-full flex justify-between items-center mb-6 px-2">
              <span className="text-sm font-medium text-gray-500 dark:text-gray-400">
                Tarjeta {currentIndex + 1} de {cards.length}
              </span>
              <span className="text-xs bg-gray-100 dark:bg-slate-700 px-2 py-1 rounded text-gray-600 dark:text-gray-300">
                 Tema {currentCard.topicId}
              </span>
            </div>

            <div 
              className="relative w-full h-80 perspective-1000 cursor-pointer group"
              onClick={() => setIsFlipped(!isFlipped)}
            >
              <div className={`relative w-full h-full duration-500 preserve-3d transition-transform ${isFlipped ? 'rotate-y-180' : ''}`}>
                
                {/* Front */}
                <div className="absolute w-full h-full backface-hidden bg-white dark:bg-slate-800 border-2 border-gray-200 dark:border-slate-700 rounded-2xl shadow-xl flex flex-col items-center justify-center p-8 text-center">
                  <p className="text-sm text-sermas-600 font-bold uppercase tracking-wider mb-4">Pregunta</p>
                  <h3 className="text-xl font-medium text-gray-800 dark:text-white">{currentCard.question}</h3>
                  <p className="mt-8 text-xs text-gray-400">(Toca para ver respuesta)</p>
                </div>

                {/* Back */}
                <div className="absolute w-full h-full backface-hidden rotate-y-180 bg-sermas-50 dark:bg-slate-900 border-2 border-sermas-200 dark:border-slate-700 rounded-2xl shadow-xl flex flex-col items-center justify-center p-8 text-center">
                  <p className="text-sm text-sermas-600 font-bold uppercase tracking-wider mb-4">Respuesta</p>
                  <p className="text-lg text-gray-700 dark:text-gray-200 leading-relaxed">{currentCard.answer}</p>
                </div>
              </div>
            </div>

            <div className="flex gap-4 mt-8 w-full max-w-sm">
              <button 
                onClick={() => handleNext(false)}
                className="flex-1 flex justify-center items-center gap-2 py-3 rounded-xl bg-red-100 hover:bg-red-200 text-red-700 font-medium transition-colors dark:bg-red-900/20 dark:text-red-300 dark:hover:bg-red-900/40"
              >
                <X className="w-5 h-5" /> Difícil
              </button>
              <button 
                onClick={() => handleNext(true)}
                className="flex-1 flex justify-center items-center gap-2 py-3 rounded-xl bg-green-100 hover:bg-green-200 text-green-700 font-medium transition-colors dark:bg-green-900/20 dark:text-green-300 dark:hover:bg-green-900/40"
              >
                <Check className="w-5 h-5" /> Fácil
              </button>
            </div>
          </div>
        );
      };

      // App.tsx
      const App: React.FC = () => {
        return (
          <StudyProvider>
            <HashRouter>
              <Layout>
                <Routes>
                  <Route path="/" element={<TopicList />} />
                  <Route path="/topic/:id" element={<TopicDetail />} />
                  <Route path="/stats" element={<Dashboard />} />
                  <Route path="/flashcards" element={<FlashcardsMode />} />
                  <Route path="*" element={<Navigate to="/" replace />} />
                </Routes>
              </Layout>
            </HashRouter>
          </StudyProvider>
        );
      };

      // 7. RENDER
      const rootElement = document.getElementById('root');
      if (rootElement) {
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
      }
    </script>
  </body>
</html>